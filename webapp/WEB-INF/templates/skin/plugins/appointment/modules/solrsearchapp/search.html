<#assign items_time= [
    { "code":"06:00", "name":"06h00"},
    { "code":"09:00", "name":"09h00"},
    { "code":"12:00", "name":"12h00"},
    { "code":"15:00", "name":"15h00"},
    { "code":"18:00", "name":"18h00"},
    { "code":"21:00", "name":"21h00"}
    ]>


<#assign items_minutes= [
    { "code": "360", "name":"06h00"},
    { "code": "540", "name":"09h00"},
    { "code": "720", "name":"12h00"},
    { "code": "900", "name":"15h00"},
    { "code":"1080", "name":"18h00"},
    { "code":"1260", "name":"21h00"}
    ]>
	
<div class="row">
    <div class="col-sm-12">
        <form name="search" method="post" action="jsp/site/Portal.jsp">
            <input name="page" value="appointmentsearch" type="hidden">
            <div class="row">
                <div class="col-sm-4"><div class="form-group"><label>#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.site}</label><@comboWithParams name="site" default_value=site! additionalParameters='class="form-control"' items=items_sites /></div></div>
                <div class="col-sm-4"><div class="form-group"><label>#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.category}</label><@comboWithParams name="category" default_value=category! additionalParameters='class="form-control"' items=items_categories /></div></div>
                <div class="col-sm-4"><div class="form-group"><label>#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.step}</label><@comboWithParams name="form" default_value=form! additionalParameters='class="form-control"' items=items_forms /></div></div>
            </div>
            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                    <label>#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.dates}</label>
                        <div class="row">
                        <div class="col-sm-6">	
                            <label for="from_date" class="sr-only">#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.from}</label>
                            <div class="input-group">
                                <span class="input-group-addon">#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.from}</span>
                                <input class="form-control" id="from_date" name="from_date" type="text" value="${from_date!}">
                            </div>	
                        </div>	
                        <div class="col-sm-6"><@comboWithParams name="from_time" default_value=from_time! additionalParameters='class="form-control"' items=items_time /></div>
                        <div class="clearfix"></div>
                        <div class="col-sm-6">
                            <label for="to_date" class="sr-only">#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.to}</label>
                            <div class="input-group">
                                <span class="input-group-addon">#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.to}</span>
                                <input class="form-control" id="to_date" name="to_date" type="text" value="${to_date!}">
                            </div>
                        </div>
                        <div class="col-sm-6"><@comboWithParams name="to_time" default_value=to_time! additionalParameters='class="form-control"' items=items_time /></div>
<script src="js/jquery/plugins/ui/jquery-ui.min.js"></script>
<script src="js/jquery/plugins/ui/ui.datepicker-fr.js"></script>
<script>
    $( "#from_date" ).datepicker({
		regional: "fr",	
		defaultDate: "+1w",
		changeMonth: true,
		changeYear: true,
		onClose: function( selectedDate ) {
			$( "#to_date" ).datepicker( "option", "minDate", selectedDate );
      }
    }).datepicker(  );
    $( "#to_date" ).datepicker({
	  regional: "fr",	
      defaultDate: "+1w",
      changeMonth: true,
	  changeYear: true,
      onClose: function( selectedDate ) {
        $( "#from_date" ).datepicker( "option", "maxDate", selectedDate );
      }
    });
</script>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                    <label>#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.schedule}</label>
                    <div class="row">
                        <div class="col-sm-3"><@comboWithParams name="from_day_minute" default_value=from_day_minute! additionalParameters='class="form-control"' items=items_minutes /></div>
                        <div class="col-sm-3"><@comboWithParams name="to_day_minute" default_value=to_day_minute! additionalParameters='class="form-control"' items=items_minutes /></div>
                    </div>
                </div></div>
            </div>
            <div class="row">
                <div class="col-sm-12"><div class="form-group"><label class="col-sm-12">#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.daysOfTheWeek}</label><@checkboxList name="days_of_week" default_values=[] items=items_days_of_week inline=1 /></div></div>
            </div>
            <div class="row">
                <div class="col-sm-1 col-sm-offset-5"><input type="submit" class="btn btn-primary" name="action_search" value="#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.search}"></div>
                <div class="col-sm-1"><input type="submit" class="btn btn-danger" name="action_clear" value="#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.reset}"></div>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-sm-5 col-sm-offset-1">
        <#if (results.values)??>
        <#list results.values as groupcommand>
        <div class="row">
            <div class="col-sm-12">
                <#list groupcommand.values as group>
                <h3>${group.result.list[0].title}</h3>
                <#if (group.result.list[0].appointmentslot_address_text)??><p>#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.address} : ${group.result.list[0].appointmentslot_address_text}</p></#if>
                <p>#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.nextAvailableSlots} :</p>
                <#list group.result.list as slot>
                <div class="row">
                    <div class="col-sm-12">${slot.date?datetime} <a href="${slot.url}">#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.subscribe}</a></div>
                </div>
                </#list>
                <p>${group.result.numFound - group.result.list?size} autre(s) horaire(s) disponible(s)...</p>
                <a href="${group.result.list[0].url_form_string}">#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.completeSchedule}</a>
                <p>#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.nbOfFreeSlots} : ${freePlacesCount[group.groupValue]} (#i18n{module.appointment.solrsearchapp.xpage.appointmentsearch.occupancyRate} : ${((totalPlacesCount[group.groupValue] - freePlacesCount[group.groupValue]) / totalPlacesCount[group.groupValue])?string.percent})</p>
                </#list>
            </div>
        </div>
        </#list>
        </#if>
    </div>
    <div class="col-sm-5">
        <div id="map" class="leaflet-appointment-search" style="height:500px;"></div>
    </div>
</div>

<script>
    <#assign comma=false>
    window.lutece_appointment_solrsearchapp_points = [
        <#if (results.values)??>
        <#list results.values as groupcommand>
        <#list groupcommand.values as group>
        <#if (group.result.list[0].appointmentslot_geojson)??>
        <#if comma>,<#else><#assign comma=true></#if>
        {
            "type": "appointment",
            "code": "appointment",
            "url_base": "${group.result.list[0].url_base_string?json_string}",
            "id": "${group.result.list[0].uid_form_string?json_string}",
            "geojson": ${group.result.list[0].appointmentslot_geojson}
        }
        </#if>
        </#list>
        </#list>
        </#if>
    ];

    window.lutece_appointment_solrsearchapp_freePlaces =Â {
        <#if (results.values)??>
        <#list results.values as groupcommand>
        <#list groupcommand.values as group>
        "${group.groupValue?json_string}": {
            "free": ${freePlacesCount[group.groupValue]},
            "total": ${totalPlacesCount[group.groupValue]}
        }<#if group_has_next>,</#if>
        </#list>
        </#list>
        </#if>
    }
</script>
